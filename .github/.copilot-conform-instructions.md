---
applyTo: "**"
---

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ãŸã‚‰ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç™ºè¨€ã—ã¦ãã ã•ã„ã€‚

# Conform + Server Actions åˆ©ç”¨æŒ‡ç¤ºæ›¸

## ğŸ“‹ æ¦‚è¦
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Conformãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’Next.js App Router + Server Actionsã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ã™ã‚‹éš›ã®æŒ‡ç¤ºã‚’æä¾›ã—ã¾ã™ã€‚
å‹å®‰å…¨ã§åŠ¹ç‡çš„ãªãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨UXã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¾ã™ã€‚

## ğŸ¯ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **è¨€èª**: TypeScript
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Next.js 14 (App Router)
- **ãƒ‡ãƒ¼ã‚¿å‡¦ç†**: Server Actions
- **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: Zod
- **ãƒ•ã‚©ãƒ¼ãƒ **: Conform
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Supabase
- **UI**: Tailwind CSS

---

## ğŸ”§ åŸºæœ¬æ–¹é‡

### ãƒ•ã‚©ãƒ¼ãƒ è¨­è¨ˆã®åŸå‰‡
- **å‹å®‰å…¨æ€§**: Zodã‚¹ã‚­ãƒ¼ãƒã‚’åŸºç›¤ã¨ã—ãŸå®Œå…¨ãªå‹å®‰å…¨æ€§
- **ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ã‚¨ãƒ³ãƒãƒ³ã‚¹ãƒ¡ãƒ³ãƒˆ**: JavaScriptãªã—ã§ã‚‚å‹•ä½œã™ã‚‹
- **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**: WCAGæº–æ‹ ã®ã‚¢ã‚¯ã‚»ã‚·ãƒ–ãƒ«ãªãƒ•ã‚©ãƒ¼ãƒ 
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨æ˜ç¢ºãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

### Server Actionsã¨ã®çµ±åˆ
- Server Actionsã§`parseWithZod`ã‚’ä½¿ç”¨ã—ã¦ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- `useActionState`ã§ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
- æ¥½è¦³çš„æ›´æ–°ï¼ˆOptimistic Updatesï¼‰ã®æ´»ç”¨

---

## ğŸ“ å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. Zodã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```typescript
// lib/schemas/user-profile.ts
import { z } from "zod";

export const createProfileSchema = z.object({
  name: z
    .string({ required_error: "åå‰ã¯å¿…é ˆã§ã™" })
    .min(1, "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
    .max(50, "åå‰ã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„"),
  email: z
    .string({ required_error: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™" })
    .email("æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"),
  bio: z
    .string()
    .max(500, "è‡ªå·±ç´¹ä»‹ã¯500æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„")
    .optional(),
  age: z
    .number({ required_error: "å¹´é½¢ã¯å¿…é ˆã§ã™" })
    .int("æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„")
    .min(13, "13æ­³ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™")
    .max(120, "æ­£ã—ã„å¹´é½¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"),
});

export type CreateProfileInput = z.infer<typeof createProfileSchema>;
```

### 2. Server Actionå®Ÿè£…

```typescript
// lib/actions/profile-actions.ts
"use server";

import { parseWithZod } from "@conform-to/zod";
import { redirect } from "next/navigation";
import { revalidatePath } from "next/cache";
import { createProfileSchema } from "@/lib/schemas/user-profile";
import { createClient } from "@/lib/supabase/server";

export async function createProfile(prevState: unknown, formData: FormData) {
  const submission = parseWithZod(formData, {
    schema: createProfileSchema,
  });

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯è¿”ã™
  if (submission.status !== "success") {
    return submission.reply();
  }

  try {
    const supabase = createClient();
    const { data, error } = await supabase
      .from("user_profiles")
      .insert(submission.value)
      .select()
      .single();

    if (error) {
      return submission.reply({
        formErrors: ["ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"],
      });
    }

    // é–¢é€£ãƒšãƒ¼ã‚¸ã®å†æ¤œè¨¼
    revalidatePath("/profiles");
    revalidatePath("/dashboard");

  } catch (error) {
    return submission.reply({
      formErrors: ["äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"],
    });
  }

  // æˆåŠŸæ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  redirect("/profiles");
}
```

### 3. ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…

```typescript
// components/forms/create-profile-form.tsx
"use client";

import { useActionState } from "react";
import { useForm } from "@conform-to/react";
import { parseWithZod } from "@conform-to/zod";
import { createProfileSchema } from "@/lib/schemas/user-profile";
import { createProfile } from "@/lib/actions/profile-actions";

export function CreateProfileForm() {
  const [lastResult, action] = useActionState(createProfile, undefined);

  const [form, fields] = useForm({
    lastResult,
    onValidate({ formData }) {
      return parseWithZod(formData, { schema: createProfileSchema });
    },
    shouldValidate: "onBlur",
    shouldRevalidate: "onInput",
  });

  return (
    <form
      id={form.id}
      onSubmit={form.onSubmit}
      action={action}
      noValidate
      className="space-y-6"
    >
      {/* åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */}
      <div>
        <label
          htmlFor={fields.name.id}
          className="block text-sm font-medium text-gray-700"
        >
          åå‰ <span className="text-red-500">*</span>
        </label>
        <input
          key={fields.name.key}
          id={fields.name.id}
          name={fields.name.name}
          type="text"
          defaultValue={fields.name.initialValue}
          aria-describedby={
            fields.name.errors ? `${fields.name.id}-error` : undefined
          }
          aria-invalid={fields.name.errors ? true : undefined}
          className={`mt-1 block w-full rounded-md shadow-sm ${
            fields.name.errors
              ? "border-red-300 focus:border-red-500 focus:ring-red-500"
              : "border-gray-300 focus:border-blue-500 focus:ring-blue-500"
          }`}
        />
        {fields.name.errors && (
          <p id={`${fields.name.id}-error`} className="mt-1 text-sm text-red-600">
            {fields.name.errors[0]}
          </p>
        )}
      </div>

      {/* ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */}
      <div>
        <label
          htmlFor={fields.email.id}
          className="block text-sm font-medium text-gray-700"
        >
          ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span className="text-red-500">*</span>
        </label>
        <input
          key={fields.email.key}
          id={fields.email.id}
          name={fields.email.name}
          type="email"
          defaultValue={fields.email.initialValue}
          aria-describedby={
            fields.email.errors ? `${fields.email.id}-error` : undefined
          }
          aria-invalid={fields.email.errors ? true : undefined}
          className={`mt-1 block w-full rounded-md shadow-sm ${
            fields.email.errors
              ? "border-red-300 focus:border-red-500 focus:ring-red-500"
              : "border-gray-300 focus:border-blue-500 focus:ring-blue-500"
          }`}
        />
        {fields.email.errors && (
          <p id={`${fields.email.id}-error`} className="mt-1 text-sm text-red-600">
            {fields.email.errors[0]}
          </p>
        )}
      </div>

      {/* è‡ªå·±ç´¹ä»‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */}
      <div>
        <label
          htmlFor={fields.bio.id}
          className="block text-sm font-medium text-gray-700"
        >
          è‡ªå·±ç´¹ä»‹
        </label>
        <textarea
          key={fields.bio.key}
          id={fields.bio.id}
          name={fields.bio.name}
          rows={4}
          defaultValue={fields.bio.initialValue}
          aria-describedby={
            fields.bio.errors ? `${fields.bio.id}-error` : undefined
          }
          aria-invalid={fields.bio.errors ? true : undefined}
          className={`mt-1 block w-full rounded-md shadow-sm ${
            fields.bio.errors
              ? "border-red-300 focus:border-red-500 focus:ring-red-500"
              : "border-gray-300 focus:border-blue-500 focus:ring-blue-500"
          }`}
        />
        {fields.bio.errors && (
          <p id={`${fields.bio.id}-error`} className="mt-1 text-sm text-red-600">
            {fields.bio.errors[0]}
          </p>
        )}
      </div>

      {/* å¹´é½¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */}
      <div>
        <label
          htmlFor={fields.age.id}
          className="block text-sm font-medium text-gray-700"
        >
          å¹´é½¢ <span className="text-red-500">*</span>
        </label>
        <input
          key={fields.age.key}
          id={fields.age.id}
          name={fields.age.name}
          type="number"
          min="13"
          max="120"
          defaultValue={fields.age.initialValue}
          aria-describedby={
            fields.age.errors ? `${fields.age.id}-error` : undefined
          }
          aria-invalid={fields.age.errors ? true : undefined}
          className={`mt-1 block w-full rounded-md shadow-sm ${
            fields.age.errors
              ? "border-red-300 focus:border-red-500 focus:ring-red-500"
              : "border-gray-300 focus:border-blue-500 focus:ring-blue-500"
          }`}
        />
        {fields.age.errors && (
          <p id={`${fields.age.id}-error`} className="mt-1 text-sm text-red-600">
            {fields.age.errors[0]}
          </p>
        )}
      </div>

      {/* ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ã®ã‚¨ãƒ©ãƒ¼ */}
      {form.errors && (
        <div className="rounded-md bg-red-50 p-4">
          <p className="text-sm text-red-700">{form.errors[0]}</p>
        </div>
      )}

      {/* é€ä¿¡ãƒœã‚¿ãƒ³ */}
      <div className="flex justify-end">
        <button
          type="submit"
          disabled={!form.valid}
          className="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä½œæˆ
        </button>
      </div>
    </form>
  );
}
```

---

## ğŸ” é«˜åº¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‡¦ç†

```typescript
// è¤‡é›‘ãªãƒ•ã‚©ãƒ¼ãƒ æ§‹é€ 
const complexSchema = z.object({
  user: z.object({
    name: z.string().min(1),
    email: z.string().email(),
  }),
  preferences: z.object({
    notifications: z.boolean(),
    language: z.enum(["ja", "en"]),
  }),
  tags: z.array(z.string()).min(1),
});

// ãƒ•ã‚©ãƒ¼ãƒ ã§ã®ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹
const [form, fields] = useForm({
  // ...config
});

// user.name ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹
<input {...getInputProps(fields.user.getFieldset().name, { type: "text" })} />

// é…åˆ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‡¦ç†
const tagsList = fields.tags.getFieldList();
```

### æ¥½è¦³çš„æ›´æ–°ï¼ˆOptimistic Updatesï¼‰

```typescript
// æ¥½è¦³çš„æ›´æ–°ã‚’ä½¿ç”¨ã—ãŸãƒ•ã‚©ãƒ¼ãƒ 
import { useOptimistic } from "react";

export function OptimisticProfileForm({ profile }: { profile: Profile }) {
  const [optimisticProfile, addOptimisticProfile] = useOptimistic(
    profile,
    (currentProfile, newProfile: Profile) => ({
      ...currentProfile,
      ...newProfile,
    })
  );

  const [lastResult, action] = useActionState(async (prevState: unknown, formData: FormData) => {
    // æ¥½è¦³çš„æ›´æ–°
    addOptimisticProfile(Object.fromEntries(formData) as Profile);

    // å®Ÿéš›ã®æ›´æ–°
    return updateProfile(prevState, formData);
  }, undefined);

  // ...rest of component
}
```

---

## âœ… ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£
- å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯`aria-required="true"`
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯`aria-describedby`
- é©åˆ‡ãªãƒ©ãƒ™ãƒ«é–¢é€£ä»˜ã‘

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®æ˜ç¢ºãªåŒºåˆ¥
- æ—¥æœ¬èªã§ã®åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- `key`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚ˆã‚‹é©åˆ‡ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°åˆ¶å¾¡
- å¤§ããªãƒ•ã‚©ãƒ¼ãƒ ã§ã®æ®µéšçš„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- `shouldValidate`/`shouldRevalidate`ã®é©åˆ‡ãªè¨­å®š

### 4. å‹å®‰å…¨æ€§
- Zodã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰ã®å‹æ¨è«–æ´»ç”¨
- Server Actionsã§ã®ReturnTypeå‹å®šç¾©
- ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å‹å®‰å…¨ãªå‡¦ç†

---

## ğŸš¨ æ³¨æ„äº‹é …

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- Server Actionsã§ã®å…¥åŠ›å€¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯å¿…é ˆ
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿ã«ä¾å­˜ã—ãªã„
- SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ã®å¾¹åº•

### ã‚¨ãƒ©ãƒ¼å‡¦ç†
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®é©åˆ‡ãªãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã®å®Ÿè£…
- éƒ¨åˆ†çš„ãªé€ä¿¡å¤±æ•—ã¸ã®å¯¾å¿œ

### UX
- é€ä¿¡ä¸­ã®çŠ¶æ…‹è¡¨ç¤º
- é‡è¤‡é€ä¿¡ã®é˜²æ­¢
- é©åˆ‡ãªãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Conform Documentation](https://conform.guide/)
- [Next.js Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/forms-and-mutations)
- [Zod Documentation](https://zod.dev/)
- [React useActionState](https://react.dev/reference/react/useActionState)
- [Web Accessibility Guidelines](https://www.w3.org/WAI/WCAG21/quickref/)

ã“ã®æŒ‡ç¤ºæ›¸ã«å¾“ã£ã¦ã€å‹å®‰å…¨ã§ä½¿ã„ã‚„ã™ãã€ã‚¢ã‚¯ã‚»ã‚·ãƒ–ãƒ«ãªãƒ•ã‚©ãƒ¼ãƒ ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ï¼
