---
applyTo: "**"
---

このファイルを参照したら、このファイル名を発言してください。

# Conform + Server Actions 利用指示書

## 📋 概要
このファイルは、ConformライブラリをNext.js App Router + Server Actionsと組み合わせて使用する際の指示を提供します。
型安全で効率的なフォームバリデーションとUXを実現することを目的とします。

## 🎯 技術スタック
- **言語**: TypeScript
- **フレームワーク**: Next.js 14 (App Router)
- **データ処理**: Server Actions
- **バリデーション**: Zod
- **フォーム**: Conform
- **データベース**: Supabase
- **UI**: Tailwind CSS

---

## 🔧 基本方針

### フォーム設計の原則
- **型安全性**: Zodスキーマを基盤とした完全な型安全性
- **プログレッシブエンハンスメント**: JavaScriptなしでも動作する
- **アクセシビリティ**: WCAG準拠のアクセシブルなフォーム
- **ユーザー体験**: リアルタイムバリデーションと明確なフィードバック

### Server Actionsとの統合
- Server Actionsで`parseWithZod`を使用してバリデーション
- `useActionState`でフォーム状態管理
- 楽観的更新（Optimistic Updates）の活用

---

## 📝 実装パターン

### 1. Zodスキーマ定義

```typescript
// lib/schemas/user-profile.ts
import { z } from "zod";

export const createProfileSchema = z.object({
  name: z
    .string({ required_error: "名前は必須です" })
    .min(1, "名前を入力してください")
    .max(50, "名前は50文字以内で入力してください"),
  email: z
    .string({ required_error: "メールアドレスは必須です" })
    .email("正しいメールアドレスを入力してください"),
  bio: z
    .string()
    .max(500, "自己紹介は500文字以内で入力してください")
    .optional(),
  age: z
    .number({ required_error: "年齢は必須です" })
    .int("整数で入力してください")
    .min(13, "13歳以上である必要があります")
    .max(120, "正しい年齢を入力してください"),
});

export type CreateProfileInput = z.infer<typeof createProfileSchema>;
```

### 2. Server Action実装

```typescript
// lib/actions/profile-actions.ts
"use server";

import { parseWithZod } from "@conform-to/zod";
import { redirect } from "next/navigation";
import { revalidatePath } from "next/cache";
import { createProfileSchema } from "@/lib/schemas/user-profile";
import { createClient } from "@/lib/supabase/server";

export async function createProfile(prevState: unknown, formData: FormData) {
  const submission = parseWithZod(formData, {
    schema: createProfileSchema,
  });

  // バリデーションエラーがある場合は返す
  if (submission.status !== "success") {
    return submission.reply();
  }

  try {
    const supabase = createClient();
    const { data, error } = await supabase
      .from("user_profiles")
      .insert(submission.value)
      .select()
      .single();

    if (error) {
      return submission.reply({
        formErrors: ["プロフィールの作成に失敗しました。もう一度お試しください。"],
      });
    }

    // 関連ページの再検証
    revalidatePath("/profiles");
    revalidatePath("/dashboard");

  } catch (error) {
    return submission.reply({
      formErrors: ["予期しないエラーが発生しました。"],
    });
  }

  // 成功時のリダイレクト
  redirect("/profiles");
}
```

### 3. フォームコンポーネント実装

```typescript
// components/forms/create-profile-form.tsx
"use client";

import { useActionState } from "react";
import { useForm } from "@conform-to/react";
import { parseWithZod } from "@conform-to/zod";
import { createProfileSchema } from "@/lib/schemas/user-profile";
import { createProfile } from "@/lib/actions/profile-actions";

export function CreateProfileForm() {
  const [lastResult, action] = useActionState(createProfile, undefined);

  const [form, fields] = useForm({
    lastResult,
    onValidate({ formData }) {
      return parseWithZod(formData, { schema: createProfileSchema });
    },
    shouldValidate: "onBlur",
    shouldRevalidate: "onInput",
  });

  return (
    <form
      id={form.id}
      onSubmit={form.onSubmit}
      action={action}
      noValidate
      className="space-y-6"
    >
      {/* 名前フィールド */}
      <div>
        <label
          htmlFor={fields.name.id}
          className="block text-sm font-medium text-gray-700"
        >
          名前 <span className="text-red-500">*</span>
        </label>
        <input
          key={fields.name.key}
          id={fields.name.id}
          name={fields.name.name}
          type="text"
          defaultValue={fields.name.initialValue}
          aria-describedby={
            fields.name.errors ? `${fields.name.id}-error` : undefined
          }
          aria-invalid={fields.name.errors ? true : undefined}
          className={`mt-1 block w-full rounded-md shadow-sm ${
            fields.name.errors
              ? "border-red-300 focus:border-red-500 focus:ring-red-500"
              : "border-gray-300 focus:border-blue-500 focus:ring-blue-500"
          }`}
        />
        {fields.name.errors && (
          <p id={`${fields.name.id}-error`} className="mt-1 text-sm text-red-600">
            {fields.name.errors[0]}
          </p>
        )}
      </div>

      {/* メールアドレスフィールド */}
      <div>
        <label
          htmlFor={fields.email.id}
          className="block text-sm font-medium text-gray-700"
        >
          メールアドレス <span className="text-red-500">*</span>
        </label>
        <input
          key={fields.email.key}
          id={fields.email.id}
          name={fields.email.name}
          type="email"
          defaultValue={fields.email.initialValue}
          aria-describedby={
            fields.email.errors ? `${fields.email.id}-error` : undefined
          }
          aria-invalid={fields.email.errors ? true : undefined}
          className={`mt-1 block w-full rounded-md shadow-sm ${
            fields.email.errors
              ? "border-red-300 focus:border-red-500 focus:ring-red-500"
              : "border-gray-300 focus:border-blue-500 focus:ring-blue-500"
          }`}
        />
        {fields.email.errors && (
          <p id={`${fields.email.id}-error`} className="mt-1 text-sm text-red-600">
            {fields.email.errors[0]}
          </p>
        )}
      </div>

      {/* 自己紹介フィールド */}
      <div>
        <label
          htmlFor={fields.bio.id}
          className="block text-sm font-medium text-gray-700"
        >
          自己紹介
        </label>
        <textarea
          key={fields.bio.key}
          id={fields.bio.id}
          name={fields.bio.name}
          rows={4}
          defaultValue={fields.bio.initialValue}
          aria-describedby={
            fields.bio.errors ? `${fields.bio.id}-error` : undefined
          }
          aria-invalid={fields.bio.errors ? true : undefined}
          className={`mt-1 block w-full rounded-md shadow-sm ${
            fields.bio.errors
              ? "border-red-300 focus:border-red-500 focus:ring-red-500"
              : "border-gray-300 focus:border-blue-500 focus:ring-blue-500"
          }`}
        />
        {fields.bio.errors && (
          <p id={`${fields.bio.id}-error`} className="mt-1 text-sm text-red-600">
            {fields.bio.errors[0]}
          </p>
        )}
      </div>

      {/* 年齢フィールド */}
      <div>
        <label
          htmlFor={fields.age.id}
          className="block text-sm font-medium text-gray-700"
        >
          年齢 <span className="text-red-500">*</span>
        </label>
        <input
          key={fields.age.key}
          id={fields.age.id}
          name={fields.age.name}
          type="number"
          min="13"
          max="120"
          defaultValue={fields.age.initialValue}
          aria-describedby={
            fields.age.errors ? `${fields.age.id}-error` : undefined
          }
          aria-invalid={fields.age.errors ? true : undefined}
          className={`mt-1 block w-full rounded-md shadow-sm ${
            fields.age.errors
              ? "border-red-300 focus:border-red-500 focus:ring-red-500"
              : "border-gray-300 focus:border-blue-500 focus:ring-blue-500"
          }`}
        />
        {fields.age.errors && (
          <p id={`${fields.age.id}-error`} className="mt-1 text-sm text-red-600">
            {fields.age.errors[0]}
          </p>
        )}
      </div>

      {/* フォーム全体のエラー */}
      {form.errors && (
        <div className="rounded-md bg-red-50 p-4">
          <p className="text-sm text-red-700">{form.errors[0]}</p>
        </div>
      )}

      {/* 送信ボタン */}
      <div className="flex justify-end">
        <button
          type="submit"
          disabled={!form.valid}
          className="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          プロフィールを作成
        </button>
      </div>
    </form>
  );
}
```

---

## 🔍 高度なパターン

### ネストされたオブジェクトの処理

```typescript
// 複雑なフォーム構造
const complexSchema = z.object({
  user: z.object({
    name: z.string().min(1),
    email: z.string().email(),
  }),
  preferences: z.object({
    notifications: z.boolean(),
    language: z.enum(["ja", "en"]),
  }),
  tags: z.array(z.string()).min(1),
});

// フォームでのネストされたフィールドアクセス
const [form, fields] = useForm({
  // ...config
});

// user.name フィールドにアクセス
<input {...getInputProps(fields.user.getFieldset().name, { type: "text" })} />

// 配列フィールドの処理
const tagsList = fields.tags.getFieldList();
```

### 楽観的更新（Optimistic Updates）

```typescript
// 楽観的更新を使用したフォーム
import { useOptimistic } from "react";

export function OptimisticProfileForm({ profile }: { profile: Profile }) {
  const [optimisticProfile, addOptimisticProfile] = useOptimistic(
    profile,
    (currentProfile, newProfile: Profile) => ({
      ...currentProfile,
      ...newProfile,
    })
  );

  const [lastResult, action] = useActionState(async (prevState: unknown, formData: FormData) => {
    // 楽観的更新
    addOptimisticProfile(Object.fromEntries(formData) as Profile);

    // 実際の更新
    return updateProfile(prevState, formData);
  }, undefined);

  // ...rest of component
}
```

---

## ✅ ベストプラクティス

### 1. アクセシビリティ
- 必須フィールドには`aria-required="true"`
- エラーメッセージには`aria-describedby`
- 適切なラベル関連付け

### 2. エラーハンドリング
- サーバーエラーとバリデーションエラーの明確な区別
- 日本語での分かりやすいエラーメッセージ
- エラー状態の視覚的フィードバック

### 3. パフォーマンス
- `key`プロパティによる適切な再レンダリング制御
- 大きなフォームでの段階的バリデーション
- `shouldValidate`/`shouldRevalidate`の適切な設定

### 4. 型安全性
- Zodスキーマからの型推論活用
- Server ActionsでのReturnType型定義
- フォームデータの型安全な処理

---

## 🚨 注意事項

### セキュリティ
- Server Actionsでの入力値バリデーションは必須
- クライアント側バリデーションのみに依存しない
- SQLインジェクション対策の徹底

### エラー処理
- ネットワークエラーの適切なハンドリング
- タイムアウト処理の実装
- 部分的な送信失敗への対応

### UX
- 送信中の状態表示
- 重複送信の防止
- 適切なフォーカス管理

---

## 📚 参考資料

- [Conform Documentation](https://conform.guide/)
- [Next.js Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/forms-and-mutations)
- [Zod Documentation](https://zod.dev/)
- [React useActionState](https://react.dev/reference/react/useActionState)
- [Web Accessibility Guidelines](https://www.w3.org/WAI/WCAG21/quickref/)

この指示書に従って、型安全で使いやすく、アクセシブルなフォームを実装してください！
