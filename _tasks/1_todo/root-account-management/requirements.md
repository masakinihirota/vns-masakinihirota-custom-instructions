# 要件定義書

## 概要

ルートアカウント管理機能は、Supabase の認証システム（auth.users）で認証されたユーザーデータを、Web アプリケーション用のユーザー管理テーブル（public.root_accounts）にコピーし、表示・管理する機能です。この機能により、認証データとアプリケーション固有のユーザーデータを分離し、より柔軟なユーザー管理を実現します。

## 要件

### 要件 1：認証データの自動コピー

**ユーザーストーリー:** ログインユーザーとして、認証データがアプリケーションのユーザー管理システムに自動的にコピーされることで、プロフィールデータを使ってアプリケーション固有の機能を利用したい。

#### 受け入れ条件

1. ユーザーが Supabase で正常に認証された時、システムは auth.users から public.root_accounts にすべてのユーザーデータをコピーする
2. ユーザーデータをコピーする時、システムは auth.users テーブルのすべてのフィールドを含める：
   - 基本情報: id、aud、role、email、phone
   - 認証状態: email_confirmed_at、phone_confirmed_at、last_sign_in_at、is_anonymous
   - メタデータ: raw_app_meta_data、raw_user_meta_data
   - 変更管理: email_change、phone_change、各種トークンとタイムスタンプ
   - その他の auth.users の全フィールド
3. そのユーザーのルートアカウントが既に存在する場合、システムは重複を作成せずに既存のレコードを更新する
4. コピー操作が完了した時、システムはアプリケーション固有フィールドに適切なデフォルト値を設定する（is_verified: false、total_points: 0、warning_count: 0）

### 要件 2：ルートアカウント情報の表示

**ユーザーストーリー:** ログインユーザーとして、自分のルートアカウントプロフィール情報を表示して、現在のアカウント状態とデータを確認したい。

#### 受け入れ条件

1. ユーザーがプロフィールページにアクセスした時、システムはルートアカウント情報を表示する
2. プロフィールデータを表示する時、システムは root_accounts テーブルから email、認証状態、総ポイント、その他関連フィールドを表示する
3. ユーザーのルートアカウントが存在しない場合、システムは認証データから自動的に作成する
4. プロフィールを表示する時、システムはタイムスタンプとデータをユーザーフレンドリーな形式でフォーマットする

### 要件 3：追加プロフィール情報の入力

**ユーザーストーリー:** ログインユーザーとして、Web アプリケーションで必要な追加のプロフィール情報を入力して、プロフィール設定を完了したい。

#### 受け入れ条件

1. ユーザーが初回ログインした時、システムは必要な追加情報でプロフィールを完成させるよう促す 2.追加データを収集する時、システムは居住地域情報やその他のアプリケーション固有フィールドを要求する
2. ユーザーが追加プロフィールデータを送信した時、システムはそれを検証してルートアカウントレコードに保存する
3. 必須フィールドが不足している場合、システムはすべての必須データが提供されるまでユーザーの進行を防ぐ

### 要件 4：自動同期とデータ整合性

**ユーザーストーリー:** システム管理者として、ルートアカウントの作成と更新が自動的に処理されることで、認証システムとアプリケーションシステム間でユーザーデータの同期が保たれることを望む。

#### 受け入れ条件

1. auth.users でユーザー認証データが変更された時、システムは対応する root_accounts レコードを自動的に更新する
2. ユーザーがログインした時、システムは root_accounts の last_login_at タイムスタンプを更新する
3. 同期プロセスが失敗した場合、システムはエラーをログに記録し、適切なフォールバック動作を提供する
4. ユーザーデータを処理する時、システムはデータ整合性を確保し、既存レコードの破損を防ぐ
