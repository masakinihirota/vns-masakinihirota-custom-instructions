# 実装計画

- [ ] 1. プロジェクト構造とコア型定義の設定
  - ルートアカウント管理機能のディレクトリ構造を作成
  - TypeScript型定義ファイルを作成（RootAccount、ProfileUpdateData等）
  - Drizzleスキーマの確認と修正（auth.usersの全フィールドに対応）
  - auth.usersテーブルの全カラムをroot_accountsに追加
  - _要件: 要件1、要件2_

- [ ] 2. データベース層の実装
- [ ] 2.1 Drizzleクエリ関数の作成
  - ルートアカウントのCRUD操作関数を実装
  - 認証ユーザーからルートアカウント作成のクエリ関数
  - ユニットテストの作成
  - _要件: 要件1.1、要件1.2、要件1.3_

- [ ] 2.2 データベース接続とエラーハンドリング
  - データベース接続ユーティリティの実装
  - エラーハンドリングクラスの作成
  - 接続失敗時のフォールバック処理
  - _要件: 要件4.3、要件4.4_

- [ ] 3. ルートアカウントサービス層の実装
- [ ] 3.1 RootAccountServiceクラスの作成
  - createOrUpdateFromAuthメソッドの実装
  - getByUserIdメソッドの実装
  - updateProfileメソッドの実装
  - updateLastLoginメソッドの実装
  - _要件: 要件1.1、要件1.4、要件2.3、要件4.2_

- [ ] 3.2 サービス層のテスト実装
  - RootAccountServiceの各メソッドのユニットテスト
  - モックデータとテストヘルパーの作成
  - エラーケースのテスト
  - _要件: 全要件のテスト_

- [ ] 4. API Routes の実装
- [ ] 4.1 プロフィール取得APIの作成
  - GET /api/profileエンドポイントの実装
  - 認証チェックとルートアカウント取得
  - レスポンス形式の統一
  - _要件: 要件2.1、要件2.2、要件2.3_

- [ ] 4.2 プロフィール更新APIの作成
  - POST /api/profileエンドポイントの実装
  - 入力データのバリデーション
  - プロフィール更新処理
  - _要件: 要件3.2、要件3.3、要件3.4_

- [ ] 4.3 同期APIの作成
  - POST /api/profile/syncエンドポイントの実装
  - 認証データとの強制同期機能
  - エラーハンドリングとログ出力
  - _要件: 要件4.1、要件4.3_

- [ ] 4.4 API統合テストの実装
  - 各エンドポイントの統合テスト
  - 認証フローのテスト
  - エラーレスポンスのテスト
  - _要件: 全API要件のテスト_

- [ ] 5. 認証ミドルウェアの実装
- [ ] 5.1 認証チェックミドルウェアの作成
  - Supabase認証状態の確認
  - ルートアカウント自動同期処理
  - 未認証時のリダイレクト処理
  - _要件: 要件1.1、要件4.1、要件4.2_

- [ ] 5.2 ミドルウェアテストの実装
  - 認証フローのテスト
  - 自動同期処理のテスト
  - リダイレクト処理のテスト
  - _要件: 認証関連要件のテスト_

- [ ] 6. プロフィール表示コンポーネントの実装
- [ ] 6.1 ProfileDisplayコンポーネントの作成
  - プロフィール情報表示UI（ProfileDisplay.tsx）
  - データフェッチロジック（ProfileDisplay.fetch.ts）
  - 表示ロジック（ProfileDisplay.logic.ts）
  - _要件: 要件2.1、要件2.2、要件2.4_

- [ ] 6.2 ProfileDisplayのテスト実装
  - コンポーネントのレンダリングテスト（ProfileDisplay.test.ts）
  - データ表示のテスト
  - エラー状態のテスト
  - _要件: 要件2のテスト_

- [ ] 7. プロフィール編集コンポーネントの実装
- [ ] 7.1 ProfileFormコンポーネントの作成
  - プロフィール編集フォームUI（ProfileForm.tsx）
  - フォームバリデーション
  - 送信処理とエラーハンドリング
  - _要件: 要件3.1、要件3.2、要件3.3、要件3.4_

- [ ] 7.2 ProfileFormのロジック実装
  - フォーム状態管理（ProfileForm.logic.ts）
  - API呼び出し処理（ProfileForm.fetch.ts）
  - バリデーション関数
  - _要件: 要件3.2、要件3.3、要件3.4_

- [ ] 7.3 ProfileFormのテスト実装
  - フォーム操作のテスト（ProfileForm.test.ts）
  - バリデーションのテスト
  - 送信処理のテスト
  - _要件: 要件3のテスト_

- [ ] 8. プロフィールコンポーネントのエクスポート管理
- [ ] 8.1 コンポーネントのindex.ts作成
  - src/components/profile/index.tsの実装
  - ProfileDisplayとProfileFormの名前付きエクスポート
  - パスエイリアス設定の確認
  - _要件: コンポーネント管理要件_

- [ ] 8.2 プロフィールページの作成（App Router）
  - src/app/profile/page.tsxの実装（App Routerのページコンポーネント）
  - コンポーネントのインポートと統合（@/components/profileから）
  - ページレイアウトとナビゲーション
  - App Routerのルーティング確認（/profileパス）
  - _要件: 要件2.1、要件3.1_

- [ ] 8.3 初回ログイン時の追加情報入力フロー
  - 初回ログイン判定ロジック
  - 必須情報入力プロンプト
  - 完了後のリダイレクト処理
  - _要件: 要件3.1、要件3.4_

- [ ] 9. E2Eテストの実装
- [ ] 9.1 ログインからプロフィール表示までのE2Eテスト
  - 認証フローのテスト
  - ルートアカウント自動作成のテスト
  - プロフィール表示のテスト
  - _要件: 要件1、要件2の統合テスト_

- [ ] 9.2 プロフィール編集フローのE2Eテスト
  - プロフィール編集のテスト
  - バリデーションエラーのテスト
  - 更新成功のテスト
  - _要件: 要件3の統合テスト_

- [ ] 10. セキュリティとパフォーマンスの最適化
- [ ] 10.1 Row Level Security (RLS) ポリシーの実装
  - ルートアカウントテーブルのRLSポリシー作成
  - ポリシーのテスト
  - セキュリティ監査
  - _要件: セキュリティ要件_

- [ ] 10.2 パフォーマンス最適化
  - データベースインデックスの最適化
  - キャッシュ戦略の実装
  - レスポンス時間の測定と改善
  - _要件: パフォーマンス要件_
